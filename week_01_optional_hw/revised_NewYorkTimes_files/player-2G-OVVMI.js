var ve=Object.defineProperty,pe=(e,t,a)=>t in e?ve(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,Z=(e,t,a)=>pe(e,"symbol"!=typeof t?t+"":t,a);import{A as F,b as I,u as J,g as x,_ as v,e as U,y as L,d as me,j as ee,E as ye,h as y,T as re,l as be,x as ge,c as we,C as he}from"./betamax-shared-CtfXo_g9.js";import{u as W,a as se,c as K,l as B,b as H,E as _e,d as te,e as Pe,f as Se,S as Ee,i as ke}from"./index-B-FVqW3A.js";import{S as Te}from"./event-types-CFKw-uz_.js";import{u as V}from"./signal-utils-C9exRBko.js";import{u as xe}from"./reduced-motion-BAaHUNZW.js";import{a as Ce}from"./intersection-observer-CkRdJA_t.js";import{V as Le}from"./video-element-BXoFWy38.js";const Me="_errorSlate_4rlmr_1",De="_playback_4rlmr_9",Ie="_alert_4rlmr_19",Fe="_icon_4rlmr_25",Ne="_info_4rlmr_37",Ve="_refresh_4rlmr_43",Oe="_stacked_4rlmr_54",Re="_message_4rlmr_59",C={errorSlate:Me,playback:De,alert:Ie,icon:Fe,info:Ne,refresh:Ve,stacked:Oe,message:Re},Ue="_container_1rsx3_5",Be="_video_1rsx3_27",He="_fit-contain_1rsx3_46",Ae="_fit-cover_1rsx3_50",We="_webkit-fullscreen_1rsx3_81",$e="_reduced-motion-check-complete_1rsx3_92",T={container:Ue,video:Be,fitContain:He,fitCover:Ae,webkitFullscreen:We,reducedMotionCheckComplete:$e};function qe(e,t){const a=F(void 0!==t?t:e.value);return I(()=>{a.current=e.value}),a.current}function je(e){var t;if(!e)return!1;const a=null==(t=e.currentSrc)?void 0:t.split(".").pop(),n="m3u8"===a?"application/x-mpegURL":`video/${a}`;return!!e.canPlayType(n)}function ie(){var e,t;const a=null==(e=J("nyt-betamax"))?void 0:e.lowLevel.videoElement.value,n=null==(t=J("nyt-betamax"))?void 0:t.player,[r]=W(),l=se(),i=F(null),o=qe(l),s="playback"===(null==l?void 0:l.value);I(()=>{"playback"===l.value&&"paused"!==(null==n?void 0:n.playState.value)?(i.current="playing"===(null==n?void 0:n.playState.peek()),"playing"===(null==n?void 0:n.playState.value)&&(null==n||n.pause(),i.current=!0)):"playback"===o&&i.current&&null===l.value&&(null==n||n.play(),i.current=null)});const u=x(()=>{var e;if(!s)return"This video is currently unavailable.";switch(null==(e=r.value)?void 0:e.code){case MediaError.MEDIA_ERR_ABORTED:return"Playback was aborted. Please refresh to try again.";case MediaError.MEDIA_ERR_NETWORK:return"The network connection was lost. Please refresh to try again.";case MediaError.MEDIA_ERR_DECODE:return"There was a playback error. Please refresh to try again.";case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:if(a&&!1===je(a))return"The selected video format is not supported.";default:return"Unable to play video. Please refresh to try again."}});return l.value?v("div",{"data-testid":"betamax-error-slate","aria-labelledby":"betamax-error-slate-label",className:U(T.video,C.errorSlate,{[C.playback]:s})},v("span",{className:U(C.alert,s&&C.stacked)},v("span",{className:U(C.icon,{[C.info]:!s,[C.refresh]:s})}),v("span",{id:"betamax-error-slate-label",className:C.message},u.value))):null}class ue extends CustomEvent{constructor(e){super(O+":unmuted",{detail:{videoElement:e}})}}function ne(e){e.target instanceof HTMLVideoElement&&!0!==e.target.muted&&window.dispatchEvent(new ue(e.target))}function Ge(e,t,a){function n(t){if(t instanceof ue&&t.detail.videoElement!==e.value){if(!e.value)return console.error("Tried to mute this video in response to another unmuting but it doesn't exist"),void K(new Error("Tried to mute this video in response to another unmuting but it doesn't exist"));"playing"===a.value&&(e.value.muted=!0)}}L(function(){if(!1===t)return;const e=O+":unmuted";return window.addEventListener(e,n),()=>window.removeEventListener(e,n)},[t])}function Je(){return!(typeof window>"u")&&!(typeof window.__VHS__>"u")}class oe extends CustomEvent{constructor(e){super(O+":play",{detail:{videoElement:e}})}}function Ke(e){e.target instanceof HTMLVideoElement&&(e.target.muted||window.dispatchEvent(new oe(e.target)))}const Ye=e=>{const{enabled:t,live:a,playState:n,setUserDrivenPlaystate:r,videoElementRef:l}=e,[i,o]=me(!1);"randomUUID"in crypto||console.error("No randomUUID function when there should be one");const s=F("randomUUID"in crypto?crypto.randomUUID():void 0);function u(e){const t=l.value;if(e instanceof oe&&e.detail.videoElement!==t){if(!t)return console.error("Tried to pause this video in response to another playing but it doesn't exist"),void K(new Error("Tried to pause this video in response to another playing but it doesn't exist"));"playing"===n.value&&!t.muted&&r("pause")}}return L(()=>{const e=O+":play";return t&&window.addEventListener(e,u),()=>window.removeEventListener(e,u)},[t]),L(()=>{function e(){Je()&&o(!0)}return typeof window<"u"&&window.addEventListener("load",e),()=>{window.removeEventListener("load",e)}},[]),L(()=>{if(null===l.value||!i)return;const e=l.value,n={isBetamax:()=>!0,isLive:()=>a,isMuted:()=>e.muted,mute:t=>{e&&(e.muted=t)},pause:()=>{t&&r("pause")},play:()=>r("play")},o=s.current;return typeof window.__VHS__<"u"&&o&&(window.__VHS__.instances[o]=n),()=>{var e;null!=(e=window.__VHS__)&&e.instances&&o&&delete window.__VHS__.instances[o]}},[l,i]),L(()=>{"playing"===n.value&&function(){const e=l.value;if(typeof window>"u"||!e||e.muted)return;const t=s.current,{instances:a}=window.__VHS__||{};if(!a)return;Object.keys(a).forEach(e=>{if(e===t)return;const n=a[e];typeof n.isBetamax<"u"||(typeof n.isLive<"u"&&n.isLive()?n.mute(!0):n.isMuted()||n.pause())})}()},[n.value]),{uuid:s.current}};function ze(e){return function(t){e.forEach(e=>e(t))}}function Qe(e,t){const a=V(t.onCanPlay),n=V(t.onPause),r=V(t.onPlay),l=t=>e.playState.value=t;return{events:{onPlay:t=>{var a;Ke(t),ne(t),l("playing"),null==(a=r.value)||a.call(r),e.buffering.value=!1,e.videoEnded.value=!1},onPlaying:()=>{l("playing"),e.buffering.value=!1,e.videoEnded.value=!1},onPause:()=>{var t;l("paused"),e.receivedBrowserPauseEvent(),null==(t=n.value)||t.call(n),e.buffering.value=!1},onVolumeChange:ze([a=>{var n;const r=a.target,l=r.muted||0===r.volume;e.muted.value!==l&&(e.muted.value=l,null==(n=t.onMuteChange)||n.call(t,l))},ne]),onTimeUpdate:t=>{if(!t.target)return;(t=>{e.currentTime.value=t})(t.target.currentTime)},onLoadedMetadata:t=>{if(!t.target)return;(t=>{e.duration.value=t})(t.target.duration)},onWaiting:()=>{e.buffering.value=!0},onEnded:t=>{var a,r;const i=t.target;i.loop||(i.pause(),l("paused"),null==(a=n.value)||a.call(n),null==(r=e.setUserDrivenPlaystate)||r.call(e,"pause"),e.videoEnded.value=!0)},onCanPlay:()=>{var e;null==(e=a.value)||e.call(a)}}}}function Xe(e,t){function a(){var a;document.fullscreenElement===t||(null==(a=document.fullscreenElement)?void 0:a.shadowRoot)===t.getRootNode()?e.value=!0:e.value=!1}return window.addEventListener("fullscreenchange",a),{enterFullscreen:()=>{const e=t.querySelector("video"),a=e&&!e.paused;async function n(){if(a&&e&&e.paused)try{return await e.play()}catch(e){throw B("Failed to resume playback in fullscreen:",e),e}return Promise.resolve()}function r(){const e=t.requestFullscreen();return e instanceof Promise?e.then(n):ae(n,100)}return a?r():ae(r,50)},exitFullscreen:()=>document.exitFullscreen(),teardown(){window.removeEventListener("fullscreenchange",a)}}}function ae(e,t){return new Promise((a,n)=>{setTimeout(()=>{e().then(a).catch(n)},t)})}function Ze(e,t,a,n,r){const l=ee(e.value),i=ee(!1);function o(){const r="fullscreen"===t.webkitPresentationMode;r!==e.value&&(r||(n.value=!1),r?t.classList.add(T.webkitFullscreen):t.classList.remove(T.webkitFullscreen),e.value=r,l.value="fulfilled",!1===r&&"playing"===a.value&&(i.value=!0,setTimeout(()=>{i.value=!1},1e3)))}function s(){"fullscreen"===t.webkitPresentationMode&&r("play"),!1===l.value&&"fullscreen"===t.webkitPresentationMode?(n.value=!1,t.webkitSetPresentationMode("inline")):!0===l.value&&"fullscreen"!==t.webkitPresentationMode&&(n.value=!0,t.webkitSetPresentationMode("fullscreen"))}return ye(()=>{!0===i.value&&"paused"===a.value&&(t.play(),i.value=!1)}),t.addEventListener("webkitpresentationmodechanged",o),t.addEventListener("playing",s),t.addEventListener("pause",function(){"fullscreen"===t.webkitPresentationMode&&r("pause")}),o(),{enterFullscreen:()=>(l.value=!0,s(),Promise.resolve()),exitFullscreen:()=>(l.value=!1,s(),Promise.resolve()),teardown(){t.removeEventListener("webkitpresentationmodechanged",o),t.removeEventListener("playing",s)}}}function et(e){e.value="not-supported";const t=()=>Promise.reject(new Error("Fullscreen not supported"));return{enterFullscreen:t,exitFullscreen:t,teardown(){}}}function tt(e,t,a,n,r){const l=y(!1),[,i]=W(),o=F(void 0);let s=null;return I(()=>{if(t.value&&e.current)return"requestFullscreen"in e.current?o.current=Xe(l,e.current):"webkitPresentationMode"in t.value?o.current=Ze(l,t.value,a,n,r):o.current=et(l),()=>{var e;null==(e=o.current)||e.teardown()};o.current=void 0}),{fullScreenSignal:l,setFullscreen:async function(e){if(!o.current)throw new Error("Fullscreen implementation is not set, it should always be");if(e){r("play"),s=window.scrollY;try{return await o.current.enterFullscreen()}catch(e){throw B("Failed to enter fullscreen:",e),i(H("failed to enter fullscreen",{type:"playback",cause:e}),!0),e}}else{null!==s&&(window.scrollTo(0,s),s=null);try{return await o.current.exitFullscreen()}catch(e){throw B("Failed to exit fullscreen:",e),i(H("failed to exit fullscreen",{type:"playback",cause:e}),!0),e}}}}}function nt(e){const t=F(new Map);return{play:re(()=>()=>{const a=[];if(t.current.forEach(e=>{const t=e();!0!==t.allowPlayback&&a.push(t.reason)}),0===a.length)return e.wrapping();console.log("[Playback Interceptor] Disallowing playback for reasons: "+a.join(", "))},[t.current]),registerPlaybackInterceptor:(e,a)=>{t.current.set(e,a)},unregisterPlaybackInterceptor:e=>{t.current.delete(e)}}}const O="nyt-betamax",at=be(O);function rt({buffering:e,captions:t,captionsAvailable:a,children:n,currentTime:r,duration:l,fullscreenSignal:i,hasEndSlate:o,muted:s,playState:u,playStateIsUserDriven:c,setFullscreen:d,setUserDrivenPlaystate:p,tracking:f,videoElement:m,visibleOnPageLoad:g,aspectRatio:b,autoplayBlocked:w,videoEnded:_}){const{registerPlaybackInterceptor:E,unregisterPlaybackInterceptor:h,play:k}=nt({wrapping:()=>p("play")}),P=y("playing"===u.value);I(()=>{"playing"===u.value&&!0!==P.value&&(P.value=!0)});const S=y(b);S.value=b;const x={aspectRatio:S,buffering:e,captions:t,captionsAvailable:a,currentTime:r,duration:l,fullscreen:i,hasEndSlate:o,hasEverPlayed:P,muted:s,autoplayBlocked:w,pause:()=>p("pause"),play:k,playState:u,setCaptions:e=>{m.value&&(t.value=e)},setCurrentTime:(e,t=!1)=>{m.value&&(m.value.currentTime=e,t||f.send(Te.Seek))},setFullscreen:d,setMuted:e=>{m.value&&(m.value.muted=e)},tracking:f,visibleOnPageLoad:g,videoEnded:_},T={registerPlaybackInterceptor:E,unregisterPlaybackInterceptor:h,videoElement:m,playStateIsUserDriven:c};return v(at.Provider,{values:{player:x,lowLevel:T}},n)}class st extends ge{constructor(){super(...arguments),Z(this,"state",{hasError:!1})}componentDidCatch(e,t){B(e),K(e,{msg:JSON.stringify(t),tags:{}}),this.props.setErrorState(H(e,{type:"render",cause:e})),this.setState({hasError:!0})}render(){return this.state.hasError?v(ie,null):this.props.children}}function it(){const e=y("visible");return L(()=>{const t=()=>e.value=document.visibilityState;return document.addEventListener("visibilitychange",t),t(),()=>{document.removeEventListener("visibilitychange",t)}},[e]),e}function ut(e,t){const a=y(void 0),n=y(!1),r=xe(),l=it(),i=Ce(t,e.visibleOnPageLoad??!1),o=x(()=>i.value&&"visible"===l.value),s=y(!0===e.play&&e.visibleOnPageLoad?"playing":"paused"),[,u]=W(),c=V(e.muted??!1),v=V("controlled"===e.playstate),d=y(e.durationInSeconds??0),p=y(!1),f=y(e.startTime??0),m=y(!1),g=x(()=>void 0!==a.value),b=V(e.play||!1),w=x(()=>void 0===a.value||!0===v.value?b.value:"play"===a.value),_=x(()=>{let t=w.value;if(!0===n.value)return!1;const a=e.pauseWhenOutOfView??"when-muted";return(!0===a||"when-muted"===a&&!0===c.value)&&(t=t&&o.value),!1===g.value&&!0===r.value&&(t=!1),t}),E=x(()=>({playValue:_.value,isUserDriven:g.value,currentPlayState:s.value}));return I(()=>{if(!t.value)return;const{playValue:a}=E.value,n=t.value;if(!1===a)return s.value="paused",void n.pause();n.duration&&(d.value=n.duration),(!0===e.alwaysPlayFromBeginning||n.currentSrc.includes(".m3u8")&&Math.abs(n.duration-n.currentTime)<.01)&&(n.currentTime=0),n.play().catch(t=>{var a;if(null==(a=e.onPlaybackError)||a.call(e,t),t instanceof Error)switch(t.name){case"NotAllowedError":return s.value="paused",void(m.value=!0);case"AbortError":return}u(H(t,{cause:t,type:"playback"}),!0)})}),{buffering:p,currentTime:f,duration:d,autoPlay:e.visibleOnPageLoad&&_.value,playState:s,muted:c,setUserDrivenPlaystate:e=>{a.value=e,"play"===e&&(n.value=!1)},receivedBrowserPauseEvent:()=>{!1!==_.value&&"hidden"!==document.visibilityState&&(n.value=!0)},playStateIsUserDriven:g,autoplayBlocked:m}}const ot="_buffering-spinner_9fcoq_11",lt="_spinner_9fcoq_28",j={bufferingSpinner:ot,spinner:lt};function ct(e){const t=null!==se().value;if(!1!==e.buffering.value&&!0!==t)return v("div",{className:j.bufferingSpinner,role:"alert","aria-label":"Loading"},v("div",{className:j.cover}),v("div",{className:j.spinner},Array(12).fill(0).map((e,t)=>v("span",{key:t}))))}function dt(e,t,a,n){const r=y(null),l=y(null),i=y(!1),o=y(!1),s=x(()=>"playing"===t.value||a.value>0);return I(()=>{if(!e.value)return;const t=e.value,a=()=>{r.value=t.textTracks[0]};return t.textTracks.addEventListener("change",a),a(),()=>t.textTracks.removeEventListener("change",a)}),I(()=>{if(!r.value||!0===i.value||!1===s.value)return void(l.value=[]);const e=r.value;e.mode="hidden";const t=()=>{l.value=e.activeCues?Array.from(e.activeCues):null};return e.addEventListener("cuechange",t),t(),()=>{e.removeEventListener("cuechange",t),e.mode="showing"}}),{forceNativeCaptions:i,activeCaptions:x(()=>{var e;if(!1===n.value)return null;const t=null==(e=l.value)?void 0:e[0];return t?{startTime:t.startTime,endTime:t.endTime,text:t.text}:null}),captionsAvailable:o}}const ft="_captionsDisplay_xgk3v_1",vt="_cueWrap_xgk3v_12",pt="_caption_xgk3v_1",G={captionsDisplay:ft,cueWrap:vt,caption:pt};function mt({captions:e}){return e.value?v("div",{"data-testid":"captions-display",className:G.captionsDisplay},v("div",{className:G.cueWrap},v("p",{className:G.caption},e.value.text))):null}function yt(e){const t=F(null);return L(()=>{const a=t.current;if(a)return n(),a.addEventListener("load",n),()=>{a.removeEventListener("load",n)};function n(){2===(null==a?void 0:a.readyState)&&(e.captionsAvailable.value=!0)}},[]),e.captions?v("track",{"data-testid":"betamax-caption-element",ref:t,src:e.captions,label:"English",kind:"captions",srcLang:"en",default:!0}):null}function bt(){const e=y(!1);return L(()=>{e.value=!0},[e]),e}function gt(e){var t,a,n;const r={},{ignoreGlobalState:l}=e;try{const t=te(e.aspectRatio);r["--video-aspect-ratio"]=String(t)||""}catch(e){console.error("[Betamax error]",e)}const i=y(null),o=y(!1),s=y(!1),[,u]=W(),{autoPlay:c,autoplayBlocked:d,buffering:p,currentTime:f,duration:m,playState:g,playStateIsUserDriven:b,setUserDrivenPlaystate:w,receivedBrowserPauseEvent:_,muted:E}=ut(e,i),h=F(null),{events:k}=Qe({playState:g,muted:E,currentTime:f,duration:m,buffering:p,receivedBrowserPauseEvent:_,setUserDrivenPlaystate:w,videoEnded:s},{onCanPlay:e.onCanPlay,onMuteChange:e.onMuteChange,onPause:e.onPause,onPlay:e.onPlay});Ye({enabled:!l||!l.includes("pause"),videoElementRef:i,live:!1,playState:g,setUserDrivenPlaystate:w});const P=Pe({element:i,props:e,playStateIsUserDriven:b,playState:g,currentTime:f,duration:m,muted:E,buffering:p}),S=!l||!1===l.includes("mute");Ge(i,S,g);const L=Se(e,i),C=y(!0),{activeCaptions:D,forceNativeCaptions:I,captionsAvailable:M}=dt(i,g,f,C),{fullScreenSignal:N,setFullscreen:O}=tt(h,i,g,I,w),R=null==(t=J("nyt-betamax-pool"))?void 0:t.pool,V=re(()=>(null==R?void 0:R.VideoRenderer)??Le,[R]),A=bt(),j=x(()=>{const e=[];return!0===A.value&&e.push(T.reducedMotionCheckComplete),e});return v("div",{className:U(T.container,"container-target",{[T.fullscreen]:N.value,[T.fitContain]:"contain"===e.fit,[T.fitCover]:"cover"===e.fit}),style:r,ref:h,"data-testid":"betamax-player",role:"group","aria-label":null!=(n=null==(a=e.trackingData)?void 0:a.mData)&&n.videoName?`${e.trackingData.mData.videoName} video`:"Video player"},v(rt,{videoElement:i,currentTime:f,duration:m,fullscreenSignal:N,hasEndSlate:o,muted:E,playState:g,playStateIsUserDriven:b,setFullscreen:O,setUserDrivenPlaystate:w,tracking:P,buffering:p,aspectRatio:te(e.aspectRatio),visibleOnPageLoad:!!e.visibleOnPageLoad,captions:C,captionsAvailable:M,autoplayBlocked:d,videoEnded:s},v(st,{setErrorState:u},v(ie,null),v("div",{className:T.video},v(V,{signal:i,className:U(j.value),muted:e.muted,autoPlay:c,loop:e.loop,crossOrigin:"anonymous",playsInline:!0,poster:e.poster,...k,preload:e.preload??"none"},L.map((t,a,n)=>v(Ee,{key:t.src,source:t,startTime:e.startTime,fallback:"fallback"in t&&t.fallback,onError:a===n.length-1&&i.value&&!1===ke(i.value,L)?e=>{B("source tag error",e),u(H("No video sources found in source",{type:"network",cause:e}),!0)}:void 0})),v(yt,{captions:e.captions,captionsAvailable:M})),v(mt,{captions:D}),v(ct,{buffering:p})),v(he,null))))}function wt(e){return v(_e,null,v(gt,{...e}))}const Ct=we(O,{"css":["https://static01.nyt.com/video-static/betamax/player-0.1.66-C4KfGpH_.css"],"js":[{"src":"https://static01.nyt.com/video-static/betamax/player-2G-OVVMI.js","entry":true},{"src":"https://static01.nyt.com/video-static/betamax/betamax-shared-CtfXo_g9.js","entry":false},{"src":"https://static01.nyt.com/video-static/betamax/index-B-FVqW3A.js","entry":false},{"src":"https://static01.nyt.com/video-static/betamax/identify-user-NlIHKxju.js","entry":false},{"src":"https://static01.nyt.com/video-static/betamax/event-types-CFKw-uz_.js","entry":false},{"src":"https://static01.nyt.com/video-static/betamax/intersection-observer-CkRdJA_t.js","entry":false},{"src":"https://static01.nyt.com/video-static/betamax/signal-utils-C9exRBko.js","entry":false},{"src":"https://static01.nyt.com/video-static/betamax/reduced-motion-BAaHUNZW.js","entry":false},{"src":"https://static01.nyt.com/video-static/betamax/video-element-BXoFWy38.js","entry":false}]},wt);export{Ct as B,O as T,qe as u};
//# sourceMappingURL=player-2G-OVVMI.js.map